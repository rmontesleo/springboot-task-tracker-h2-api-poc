
name: PoC CI Demo

on:
  push:
    branches:
      - main

env:
  # Define common environment variables
  JAVA_VERSION: 21
  PROJECT_NAME: 'springboot-task-tracker-h2-api-poc'
  DOCKERFILE_PATH: 'Dockerfile'
  

jobs:
  # Job 1: Build jar, Docker Image and execute Unit Tests
  test_and_build:
    runs-on: ubuntu-latest
    outputs:
      jaf_file_name: ${{ steps.get-jar-name.outputs.jar_name }}
      docker_image_tag: ${{ steps.get-tag-name.outputs.docker_tag }}
      project_version: ${{ steps.get-version.outputs.project_version }}

    steps:
        - name: Checkout Code
          uses: actions/checkout@v4
        
        - name: Set up Java ${{ env.JAVA_VERSION }}
          uses: actions/setup-java@v4
          with:
              distribution: 'temurin'
              java-version: ${{ env.JAVA_VERSION }}
              cache: 'maven'

        - name: Get Maven Project Version
          id: get-version
          run: |
            PROJECT_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
            echo "project_version=$PROJECT_VERSION" >> $GITHUB_OUTPUT
            echo "Discovered project version: $PROJECT_VERSION"

        - name: Build Maven Project and Get JAR Name
          id: get-jar-name
          run: |
            #Build without test run in the next step
            mvn clean package -DskipTests 
            JAR_NAME=$(ls target/*.jar | head -n 1 | xargs -n 1 basename )
            echo "jar_name=$JAR_NAME" >> "$GITHUB_OUTPUT"
            echo "Discovered JAR name: $JAR_NAME"

        - name: Execute Unit Test
          env:
            MAVEN_OPTS: -Dmaven.wagon.http.pool=false -Dmaven.wagon.http.retryHandler.count=3
          run: mvn test  

        - name: Upload JAR Artifact
          uses: actions/upload-artifact@v4
          if: ${{ success()}}
          with:
            name: ${{ env.PROJECT_NAME }}-jar
            path: target/${{ steps.get-jar-name.outputs.jar_name }}
            retention-days: 7    

        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3

        - name: Build Docker Image
          id: build-image
          uses: docker/build-push-action@v5
          with:
            context: .
            file: ${{ env.DOCKERFILE_PATH }}
            push: false # Only build locally
            load: true # Load the image into Docker
            tags: ${{ env.PROJECT_NAME }}:${{ github.sha }}
            target: production

        - name: Get docker tag name
          id: get-tag-name
          run: |
            TAG_NAME="${{ env.PROJECT_NAME }}:${{ github.sha }}"
            echo "docker_tag=$TAG_NAME" >> "$GITHUB_OUTPUT"
            echo "TAG_NAME is $TAG_NAME"


        - name: List Docker Images
          run: docker images    
          

        - name: Export Docker Image to Tar (for subsequent jobs)
          run: docker save ${{ env.PROJECT_NAME }}:${{ github.sha}} -o ${{ env.PROJECT_NAME}}.tar

        - name: Upload Docker Image Tarball Artifact
          uses: actions/upload-artifact@v4
          if: ${{ success() }}
          with:
            name: ${{ env.PROJECT_NAME }}-docker-image
            path: ${{ env.PROJECT_NAME }}.tar
            retention-days: 7

  # Job 2: Run Security Scans ()
  # These are often part of a 'security' gate can run in parallel with quality/vulnerability scans.
  security-scans:
    runs-on: ubuntu-latest
    needs: test_and_build 
    continue-on-error: true

    steps:
      - name: Download Source Code
        uses: actions/checkout@v4

      - name: Download Jar Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.PROJECT_NAME}}-jar
          path: ./dowloaded-artifacts/jar/
        
      - name: Download Docker Image Tarball
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.PROJECT_NAME }}-docker-image
          path: ./dowloaded-artifacts/docker-image/

      
      - name: Load Docker Image
        run: docker load -i ./dowloaded-artifacts/docker-image/${{env.PROJECT_NAME}}.tar

      - name: Verify components are placed
        run: |
          ls
          ls ./dowloaded-artifacts/docker-image/
          ls ./dowloaded-artifacts/jar/
          docker images  

      - name: Docker Scout Scan (CVES)
        env:
            DOCKER_BUILDKIT: 1  # Ensure Docker is running in buildkit mode
        run: |
          docker scout cves --format sarif --output  docker_scout_report.sarif  archive://dowloaded-artifacts/docker-image/${{ env.PROJECT_NAME}}.tar 
        
      